<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>同城代买</title>
    <th:block th:include="common/base::proejct-context" th:remove="tag"/>
</head>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=xwWID35KbLINQjL50sazS4TmLAo8wUFx"></script>
<style>
    .type{
        width: 70%;
        height: 30px;
        background-color: #feffeb;
        margin-left: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: center;
    }

    .goods{
        width: 100px;
        height: 140px;
        float: left;
        margin-left: 15px;
        margin-top: 10px;
    }

    .goodImg{
        width: 100%;height: 70%
    }

    .shopCar{
        width: 20px;height: 20px;float: right;
    }
</style>
<body>
<div>
    <div class="col-md-8 order-md-1">
        <div class="row">
            <div class="col-md-7 mb-3">
                <div id="map" style="width: 100%;height: 350px"></div>
            </div>
            <div class="col-md-5 mb-3">
                <div class="mb-3">
                    <label for="myPos">我的位置：</label>
                    <input type="text" class="form-control" name="myPos" id="myPos" placeholder="定位不准时手动输入：" required="">
                    <div class="invalid-feedback">
                        请输入
                    </div>
                </div>
                <div class="mb-3">
                    <label for="searchGoods">搜索关键字：</label>
                    <input type="text" class="form-control" name="searchGoods" id="searchGoods" placeholder="请输入您想购买的商品：" required="">
                    <div class="invalid-feedback">
                        请输入
                    </div>
                </div>
                <div class="mb-3">
                    <label for="dist">搜索距离（m）：</label>
                    <input type="number" class="form-control" name="dist" id="dist" placeholder="请输入搜索半径范围：默认1000m" required="">
                    <div class="invalid-feedback">
                        请输入
                    </div>
                </div>
                <button class="btn btn-primary btn-lg btn-block" onclick="searchNow()">搜索！</button>
            </div>

        </div>
        <div class="row" style="height: 500px;">
            <div class="col-md-12 mb-3">
                <div style="width: 100%;height:500px;border: 1px solid black;margin: 0 auto">
                    <div style="width: 95%;height: 100px;margin: 0 auto">
                        <div style="float: left;width: 40%">
                            <img style="width:130px;height: 90px;margin-left: 20px" th:src="@{/image/buy.jpeg}" alt="">
                        </div>
                        <div style="float: left">
                            <div style="font-weight: bold">星巴克</div>
                            <div>营业时间</div>
                            <div>当前状态：<span style="color: #2e5417;">营业中</span></div>
                            <div><img th:src="@{/image/pos.png}" style="width: 15px;height: 15px;" alt="">地址地址地址地址地址地址</div>
                        </div>
                    </div>
                    <div style="margin-left: 20%;margin-top: 5px;">
                        <input style="width: 250px;float: left" type="text"  class="form-control" name="search" placeholder="请输入您想购买的商品：" required="">
                        <button style="width:80px;float: left" class="btn btn-primary">搜索</button>
                    </div>
                    <div style="width: 100%;height:350px;clear: left;overflow-y: scroll">
                        <div style="float: left;width: 30%;height: 350px;overflow-y: scroll" >
                            <div class="type">热卖商品</div>
                            <div class="type">大师咖啡</div>
                            <div class="type">星冰乐</div>
                            <div class="type">甜点</div>
                            <div class="type">蛋糕</div>
                            <div class="type">冰摇茶</div>
                            <div class="type">三明治</div>
                            <div class="type">摩卡</div>
                            <div class="type">拿铁</div>
                        </div>

                        <div style="float: left;width: 70%;height: 350px;overflow-y: scroll" >
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>

                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                            <div class="goods" >
                                <div><img class="goodImg" style="" th:src="@{/image/send.jpeg}" alt=""></div>
                                <div>商品名称</div>
                                <div><span>¥30</span><img class="shopCar" th:src="@{/image/shopCar.png}" alt=""></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 10px">
            <div class="col-md-6 mb-3">
                <button class="btn btn-primary btn-lg btn-block" onclick="buyCar()">购物车</button>
            </div>
            <div class="col-md-6 mb-3">
                <button class="btn btn-primary btn-lg btn-block" onclick="orderNow()">下单</button>
            </div>

        </div>
    </div>
</div>
</body>

<script type="text/javascript" th:inline="javascript">

    var map = new BMap.Map("map");
    // 初始化地图，设置中心点坐标和地图级
    map.centerAndZoom(new BMap.Point(118.70328, 32.180044), 15);
    map.enableScrollWheelZoom(true);
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});
    map.addControl(top_left_control);
    //设置定位按钮位置
    var opts = {anchor:BMAP_ANCHOR_BOTTOM_RIGHT};
    //设置缩放按钮位置及类型
    var ove={anchor:BMAP_ANCHOR_TOP_RIGHT,type:BMAP_NAVIGATION_CONTROL_ZOOM};
    //将定位控件添加到地图上
    map.addControl(new BMap.GeolocationControl(opts));
    //添加缩放按钮
    map.addControl(new BMap.NavigationControl(ove));


    //初始化地图脚本
    //保存开始位置
    var startPos;

    var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
        {
            "input": "myPos",
            "location": map
        });

    var startValue;
    ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
        var _value = e.item.value;
        startValue = _value.province + _value.city + _value.district + _value.street + _value.business;
        setStartPlace();
    });

    function setStartPlace() {// 创建地址解析器实例
        var myGeo = new BMap.Geocoder();// 将地址解析结果显示在地图上,并调整地图视野
        myGeo.getPoint(startValue, function (point) {
            if (point) {
                //将地址存在临时input中
                startPos = point;
                map.panTo(point, 8);
                setTimeout(function(){
                    map.setZoom(16);
                }, 500);
                var marker = new BMap.Marker(point);        // 创建标注
                map.addOverlay(marker);
                console.log("起始坐标："+ JSON.stringify(point))
            }
        });
    }

    function searchNow(){
        if(startPos===null||startPos===""||startPos===undefined){
            alert("请输入我的位置～");
            return false;
        }
        var q = $("#searchGoods").val().trim();
        if(q===null||q===""||q===undefined){
            return alert("请输入想要查询的物品～");
            return false;
        }
        var radius = $("#dist").val().trim();
        if(radius===null||radius===""||radius===undefined){
            radius = 1000;
        }
        var loc = startPos.lng+","+startPos.lat;
        var url = "http://api.map.baidu.com/geosearch/v3/nearby?" +
            "ak=xwWID35KbLINQjL50sazS4TmLAo8wUFx&geotable_id=201864&location="
            +loc+"&q="+q+"&radius="+radius +"&callback=showInfo";
        $.getScript(url);

    }

    /**
     * 显示商家
     */
    function showInfo(dataInfo){
        console.log(dataInfo);

        if(dataInfo.status!==0){
            alert("调用百度地图api失败！请重试～");
            return false;
        }
        if(dataInfo.size===0){
            alert("您的范围内没有您想要的东西～请重试～");
            return false;
        }
        var opts = {
            width : 250,     // 信息窗口宽度
            height: 80,     // 信息窗口高度
            title : "商家信息" , // 信息窗口标题
            enableMessage:true//设置允许信息窗发送短息
        };
        var shopInfo = dataInfo.contents;
        var viewPoints =[];
        for(var i=0;i<shopInfo.length;i++){
            var shop = shopInfo[i];
            viewPoints.push(shop.location);
            var marker = new BMap.Marker(new BMap.Point(shop.location[0],shop.location[1]));  // 创建标注
            var shopName = shop.title;
            var tags = shop.tags;
            var address = shop.address;
            var shopUrl = shop.shopUrl;
            var content = "<a style='color: #006ace;' type='"+shopUrl+"' onclick='getShop(this)'>"+ shopName+"</br>标签："+tags+"</br>地址："+address+"</a>";
            map.addOverlay(marker);               // 将标注添加到地图中
            addClickHandler(content,marker);
        }
       //自动缩放问题未解决
        /*
       var view = map.getViewport(eval(viewPoints));
        var mapZoom = view.zoom;
        var centerPoint = view.center;
        map.centerAndZoom(centerPoint, mapZoom);*/
    }

    function addClickHandler(content,marker){
        marker.addEventListener("click",function(e){
            openInfo(content,e)}
        );
    }
    function openInfo(content,e){
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    
    
    function getShop(data){
        var url = data.type;
        console.log(url);

        $.ajax({
            type: "post",
            url:ctxPath+ "/getShopInfo",
            data: {shopInfo:url},
            dataType: "json",
            success: function (result) {
                if(result.flag){
                    alert(JSON.stringify(result));
                }
                else{
                    alert(result.message);
                }
            },
            error: function (result) {
                console.log(result);
            }
        });
    }
</script>
</html>